---

- name: Check swap
  ansible.builtin.shell: "swapon --show --noheadings | wc -l"
  register: swap_ret

- name: If enabled -disable it
  ansible.builtin.command: swapoff -a
  when: swap_ret.stdout != "0"

- name: Disable SWAP in fstab
  when: swap_ret.stdout != "0"
  ansible.builtin.replace:
    path: /etc/fstab
    regexp: '^([^#].*\s*swap\s*.*)$'
    replace: '#\1'

- name: Set crictl.yaml
  ansible.builtin.template:
    src: crictl.j2
    dest: /etc/crictl.yaml
    owner: root
    mode: u=rw,g=r,o=r


- name: Load modules br_netfilter
  community.general.modprobe:
    name: br_netfilter
    state: present
    persistent: present

- name: Load br_netfilter on load
  ansible.builtin.copy:
    src: modules-kubernetes.conf
    dest: /etc/modules-load.d/modules-kubernetes.conf
    owner: root
    mode: u=rw,g=r,o=r

- name: Set Sysctl
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value  }}"
    state: present
  with_items:
    - name: net.ipv4.ip_forward
      value: 1
    - name: net.bridge.bridge-nf-call-iptables
      value: 1
    - name: net.bridge.bridge-nf-call-ip6tables
      value: 1
    - name: net.ipv4.ip_nonlocal_bind # for HA
      value: 1

- name: Install packages
  ansible.builtin.apt:
    pkg:
      - apt-transport-https
      - ca-certificates
      - curl
      - gpg
      - bash-completion
      - python3
      - tar
      - chrony
      - vim
      - jq
      - git

- name: Enable NTP server chrony
  ansible.builtin.service:
    name: chronyd
    state: started



- name: Install containerd
  when: cri == "containerd"
  ansible.builtin.include_tasks: containerd.yml


- name: Install kubernetes
  block:

    #######################################################################
    # (APT) â€” DISABLED, pkgs.k8s.io, CDN 403/timeout
    #######################################################################
    # - name: Add k8s apt-key
    #   ansible.builtin.apt_key:
    #     url: "https://{{ imageRepository }}/core:/stable:/v{{ kube_version | regex_search('[0-9]+.[0-9]+') }}/deb/Release.key"
    #     state: present
    #     keyring: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    #
    # - name: Add k8s apt repository
    #   ansible.builtin.apt_repository:
    #     repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://{{ imageRepository }}/core:/stable:/v{{ kube_version | regex_search('[0-9]+.[0-9]+') }}/deb/ /"
    #     state: present
    #     filename: kubernetes
    #
    # - name: Install k8s utils
    #   ansible.builtin.apt:
    #     pkg:
    #       - kubectl
    #       - kubelet
    #       - kubeadm
    #     state: present
    #
    # - name: apt-mark-hold kubectl
    #   ansible.builtin.dpkg_selections:
    #     name: kubectl
    #     selection: hold
    #
    # - name: apt-mark-hold kubelet
    #   ansible.builtin.dpkg_selections:
    #     name: kubelet
    #     selection: hold
    #
    # - name: apt-mark-hold kubeadm
    #   ansible.builtin.dpkg_selections:
    #     name: kubeadm
    #     selection: hold


    #######################################################################
    #                          BINARY INSTALL                             #
    #######################################################################

    - name: Create CNI directory
      ansible.builtin.file:
        path: /opt/cni/bin
        state: directory
        mode: "0755"

    - name: Install CNI plugins
      ansible.builtin.unarchive:
        src: "https://github.com/containernetworking/plugins/releases/download/{{ cni_plugins_version }}/cni-plugins-linux-amd64-{{ cni_plugins_version }}.tgz"
        dest: /opt/cni/bin
        remote_src: yes

    - name: Ensure directory exists
      ansible.builtin.file:
        path: /usr/local/bin
        state: directory
        mode: "0755"

    - name: Install crictl
      ansible.builtin.unarchive:
        src: "https://github.com/kubernetes-sigs/cri-tools/releases/download/{{ crictl_version }}/crictl-{{ crictl_version }}-linux-amd64.tar.gz"
        dest: /usr/local/bin
        remote_src: yes

    - name: Download kubeadm, kubectl, kubelet
      ansible.builtin.get_url:
        url: "https://dl.k8s.io/release/v{{ kube_version }}/bin/linux/amd64/{{ item }}"
        dest: "/usr/local/bin/{{ item }}"
        mode: "0755"
      loop:
        - kubeadm
        - kubelet
        - kubectl

    - name: Install kubelet.service
      ansible.builtin.shell: |
        curl -sSL https://raw.githubusercontent.com/kubernetes/release/{{ systemd_version }}/cmd/krel/templates/latest/kubelet/kubelet.service \
        | sed "s:/usr/bin:/usr/local/bin:g" \
        | tee /usr/lib/systemd/system/kubelet.service
      args:
        executable: /bin/bash

    - name: Install 10-kubeadm.conf
      ansible.builtin.shell: |
        mkdir -p /usr/lib/systemd/system/kubelet.service.d
        curl -sSL https://raw.githubusercontent.com/kubernetes/release/{{ systemd_version }}/cmd/krel/templates/latest/kubeadm/10-kubeadm.conf \
        | sed "s:/usr/bin:/usr/local/bin:g" \
        | tee /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf
      args:
        executable: /bin/bash

    - name: Reboot machine
      ansible.builtin.reboot:
